esphome:
  name: "energy-dashboard"
  friendly_name: "Energie Dashboard"

esp32:
  variant: esp32s3
  framework:
    type: esp-idf

psram:
  mode: octal
  speed: 80MHz

logger:

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:

ota:
  - platform: esphome
    on_begin:
      - light.turn_off:
          id: display_backlight
          transition_length: 0s
      - lambda: "id(display_backlight).loop();"

# Backlight Control
output:
  - platform: ledc
    id: backlight_output
    pin: GPIO38
    frequency: 150Hz
    min_power: 0.01
    zero_means_zero: true

light:
  - platform: monochromatic
    name: "Backlight"
    id: display_backlight
    output: backlight_output
    restore_mode: ALWAYS_ON
    default_transition_length: 1s

# SPI für Display
spi:
  - id: lcd_spi
    clk_pin: GPIO48
    mosi_pin: GPIO47

# I2C für Touchscreen
i2c:
  - id: touchscreen_bus
    sda: GPIO19
    scl:
      number: 45
      ignore_strapping_warning: true

# Display Konfiguration
display:
  - platform: st7701s
    id: tft_display
    dimensions:
      width: 480
      height: 480
    rotation: 270
    spi_mode: MODE3
    data_rate: 2MHz
    color_order: RGB
    invert_colors: false
    cs_pin: 39
    de_pin: 18
    hsync_pin: 16
    vsync_pin: 17
    pclk_pin: 21
    pclk_frequency: 12MHz
    pclk_inverted: false
    hsync_pulse_width: 8
    hsync_front_porch: 10
    hsync_back_porch: 20
    vsync_pulse_width: 8
    vsync_front_porch: 10
    vsync_back_porch: 10
    update_interval: never
    auto_clear_enabled: false
    init_sequence:
      - 1
      - [0xFF, 0x77, 0x01, 0x00, 0x00, 0x10]
      - [0xCD, 0x00]
    data_pins:
      red: [11, 12, 13, 14, 0]
      green: [8, 20, 3, 46, 9, 10]
      blue: [4, 5, 6, 7, 15]

# Touchscreen
touchscreen:
  - platform: gt911
    id: tft_touch
    display: tft_display
    i2c_id: touchscreen_bus

# Home Assistant Sensoren
sensor:
  - platform: homeassistant
    id: solar_power
    entity_id: sensor.solar_power
    internal: true
  
  - platform: homeassistant
    id: grid_power
    entity_id: sensor.grid_power
    internal: true
  
  - platform: homeassistant
    id: battery_power
    entity_id: sensor.battery_power
    internal: true
  
  - platform: homeassistant
    id: home_power
    entity_id: sensor.home_power
    internal: true
  
  - platform: homeassistant
    id: battery_soc
    entity_id: sensor.battery_soc
    internal: true

# Zeit von Home Assistant
time:
  - platform: homeassistant
    id: ha_time

# LVGL Konfiguration
lvgl:
  log_level: INFO
  color_depth: 16
  
  displays:
    - tft_display
  
  touchscreens:
    - tft_touch
  
  # Style Definitionen
  style_definitions:
    - id: style_circle
      bg_opa: TRANSP
      border_width: 0
      pad_all: 0
      radius: 1000
    
    - id: style_arc_green
      arc_width: 8
      arc_color: 0x00FF00
      arc_rounded: true
    
    - id: style_arc_red
      arc_width: 8
      arc_color: 0xFF0000
      arc_rounded: true
    
    - id: style_arc_blue
      arc_width: 8
      arc_color: 0x3399FF
      arc_rounded: true
    
    - id: style_arc_yellow
      arc_width: 8
      arc_color: 0xFFAA00
      arc_rounded: true
  
  # Widgets
  pages:
    - id: main_page
      bg_color: 0x000000
      widgets:
        # Zeit Display oben
        - label:
            id: time_label
            align: TOP_MID
            y: 15
            text: "12:14"
            text_font: roboto_32
            text_color: 0x4488FF
        
        # === Energiefluss Linien mit Kurven (transparente Linien) ===
        # Solar -> Mitte (nach unten, dann rechts mit Kurve)
        - line:
            id: line_solar_v
            points:
              - 100, 190
              - 100, 230
            line_color: 0x003300
            line_width: 4
        - line:
            id: line_solar_curve
            points:
              - 100, 230
              - 110, 235
              - 120, 238
            line_color: 0x003300
            line_width: 4
        - line:
            id: line_solar_h
            points:
              - 120, 238
              - 210, 238
            line_color: 0x003300
            line_width: 4
        
        # Mitte -> Grid (nach rechts, dann hoch mit Kurve)
        - line:
            id: line_grid_h
            points:
              - 270, 220
              - 360, 220
            line_color: 0x330000
            line_width: 4
        - line:
            id: line_grid_curve
            points:
              - 360, 220
              - 370, 210
              - 378, 195
            line_color: 0x330000
            line_width: 4
        - line:
            id: line_grid_v
            points:
              - 378, 195
              - 378, 190
            line_color: 0x330000
            line_width: 4
        
        # Mitte -> Home (direkt horizontal)
        - line:
            id: line_home
            points:
              - 270, 260
              - 330, 260
            line_color: 0x003300
            line_width: 4
        
        # Battery -> Mitte (nach oben, dann rechts mit Kurve)
        - line:
            id: line_battery_v
            points:
              - 100, 330
              - 100, 285
            line_color: 0x002244
            line_width: 4
        - line:
            id: line_battery_curve
            points:
              - 100, 285
              - 110, 278
              - 120, 275
            line_color: 0x002244
            line_width: 4
        - line:
            id: line_battery_h
            points:
              - 120, 275
              - 210, 275
            line_color: 0x002244
            line_width: 4
        
        # Mitte -> Backup (nach rechts, dann runter mit Kurve)
        - line:
            id: line_backup_h
            points:
              - 270, 295
              - 360, 295
            line_color: 0x003300
            line_width: 4
        - line:
            id: line_backup_curve
            points:
              - 360, 295
              - 370, 305
              - 378, 320
            line_color: 0x003300
            line_width: 4
        - line:
            id: line_backup_v
            points:
              - 378, 320
              - 378, 330
            line_color: 0x003300
            line_width: 4
        
        # Animierte Energiefluss-Segmente (leuchtende Teile)
        - obj:
            id: flow_segment_solar
            x: 100
            y: 190
            width: 4
            height: 20
            bg_color: 0x00FF00
            radius: 2
            border_width: 0
        
        - obj:
            id: flow_segment_grid
            x: 270
            y: 218
            width: 20
            height: 4
            bg_color: 0xFF0000
            radius: 2
            border_width: 0
        
        - obj:
            id: flow_segment_battery
            x: 100
            y: 310
            width: 4
            height: 20
            bg_color: 0x3399FF
            radius: 2
            border_width: 0
        
        - obj:
            id: flow_segment_home
            x: 270
            y: 258
            width: 20
            height: 4
            bg_color: 0x00FF00
            radius: 2
            border_width: 0
        
        - obj:
            id: flow_segment_backup
            x: 270
            y: 293
            width: 20
            height: 4
            bg_color: 0x00FF00
            radius: 2
            border_width: 0
        
        # === LEAF ICON Mitte mit Border ===
        - obj:
            id: center_circle
            align: CENTER
            x: 0
            y: 0
            width: 70
            height: 70
            bg_color: 0x001100
            border_color: 0x00AA44
            border_width: 3
            radius: 35
            widgets:
              - label:
                  align: CENTER
                  text: "\U000F0DEE"
                  text_font: icons_48
                  text_color: 0x00DD66
        
        # === SOLAR (Links Oben) ===
        - obj:
            id: solar_circle
            x: 50
            y: 90
            width: 100
            height: 100
            bg_color: 0x001100
            border_color: 0x00FF00
            border_width: 3
            radius: 50
            pad_all: 5
            scrollbar_mode: "off"
            clickable: false
            widgets:
              - arc:
                  id: solar_arc
                  align: CENTER
                  width: 90
                  height: 90
                  start_angle: 270
                  end_angle: 270
                  rotation: 0
                  value: 0
                  min_value: 0
                  max_value: 100
                  arc_color: 0x003300
                  arc_width: 8
                  indicator:
                    arc_color: 0x00FF00
                    arc_width: 8
              
              - label:
                  id: solar_icon
                  align: CENTER
                  y: -15
                  text: "\U000F0A72"  # mdi:solar-power
                  text_font: icons_32
                  text_color: 0x00FF00
              
              - label:
                  id: solar_value
                  align: CENTER
                  y: 10
                  text: "0.0"
                  text_font: roboto_16
                  text_color: 0xFFFFFF
              
              - label:
                  align: CENTER
                  y: 30
                  text: "kW"
                  text_font: roboto_16
                  text_color: 0x888888
        
        # === GRID (Rechts Oben) ===
        - obj:
            id: grid_circle
            x: 330
            y: 90
            width: 100
            height: 100
            bg_color: 0x110000
            border_color: 0xFF0000
            border_width: 3
            radius: 50
            scrollbar_mode: "off"
            clickable: false
            widgets:
              - arc:
                  id: grid_arc
                  align: CENTER
                  width: 90
                  height: 90
                  start_angle: 270
                  end_angle: 270
                  value: 0
                  min_value: 0
                  max_value: 100
                  arc_color: 0x330000
                  arc_width: 8
                  indicator:
                    arc_color: 0xFF0000
                    arc_width: 8
              
              - label:
                  align: CENTER
                  y: -15
                  text: "\U000F0239"  # mdi:transmission-tower
                  text_font: icons_32
                  text_color: 0xFF0000
              
              - label:
                  id: grid_value
                  align: CENTER
                  y: 10
                  text: "0.0"
                  text_font: roboto_16
                  text_color: 0xFFFFFF
              
              - label:
                  align: CENTER
                  y: 30
                  text: "kW"
                  text_font: roboto_16
                  text_color: 0x888888
        
        # === LEAF ICON Mitte ===
        - label:
            align: CENTER
            x: 0
            y: 0
            text: "\U000F0DEE"  # mdi:leaf
            text_font: icons_48
            text_color: 0x00AA44
        
        # === HOME (Rechts Mitte) ===
        - obj:
            id: home_circle
            x: 330
            y: 210
            width: 100
            height: 100
            bg_color: 0x001100
            border_color: 0x00FF00
            border_width: 3
            radius: 50
            scrollbar_mode: "off"
            clickable: false
            widgets:
              - arc:
                  id: home_arc
                  align: CENTER
                  width: 90
                  height: 90
                  start_angle: 270
                  end_angle: 270
                  value: 0
                  min_value: 0
                  max_value: 100
                  arc_color: 0x003300
                  arc_width: 8
                  indicator:
                    arc_color: 0x00FF00
                    arc_width: 8
              
              - label:
                  align: CENTER
                  y: -15
                  text: "\U000F02DC"  # mdi:home
                  text_font: icons_32
                  text_color: 0x00FF00
              
              - label:
                  id: home_value
                  align: CENTER
                  y: 10
                  text: "0.0"
                  text_font: roboto_16
                  text_color: 0xFFFFFF
              
              - label:
                  align: CENTER
                  y: 30
                  text: "kW"
                  text_font: roboto_16
                  text_color: 0x888888
        
        # === BATTERY (Links Unten) ===
        - obj:
            id: battery_circle
            x: 50
            y: 330
            width: 100
            height: 100
            bg_color: 0x001122
            border_color: 0x3399FF
            border_width: 3
            radius: 50
            scrollbar_mode: "off"
            clickable: false
            widgets:
              - arc:
                  id: battery_arc
                  align: CENTER
                  width: 90
                  height: 90
                  start_angle: 270
                  end_angle: 270
                  value: 0
                  min_value: 0
                  max_value: 100
                  arc_color: 0x002244
                  arc_width: 8
                  indicator:
                    arc_color: 0x3399FF
                    arc_width: 8
              
              - label:
                  align: CENTER
                  y: -15
                  text: "\U000F0079"  # mdi:battery
                  text_font: icons_32
                  text_color: 0x3399FF
              
              - label:
                  id: battery_value
                  align: CENTER
                  y: 10
                  text: "0.0"
                  text_font: roboto_16
                  text_color: 0xFFFFFF
              
              - label:
                  align: CENTER
                  y: 30
                  text: "kW"
                  text_font: roboto_16
                  text_color: 0x888888
        
        # === BACKUP HOME (Rechts Unten) ===
        - obj:
            id: backup_circle
            x: 330
            y: 330
            width: 100
            height: 100
            bg_color: 0x001100
            border_color: 0x00FF00
            border_width: 3
            radius: 50
            scrollbar_mode: "off"
            clickable: false
            widgets:
              - arc:
                  id: backup_arc
                  align: CENTER
                  width: 90
                  height: 90
                  start_angle: 270
                  end_angle: 270
                  value: 0
                  min_value: 0
                  max_value: 100
                  arc_color: 0x003300
                  arc_width: 8
                  indicator:
                    arc_color: 0x00FF00
                    arc_width: 8
              
              - label:
                  align: CENTER
                  y: -15
                  text: "\U000F0ADB"  # mdi:home-lightning-bolt
                  text_font: icons_32
                  text_color: 0x00FF00
              
              - label:
                  id: backup_value
                  align: CENTER
                  y: 10
                  text: "0.0"
                  text_font: roboto_16
                  text_color: 0xFFFFFF
              
              - label:
                  align: CENTER
                  y: 30
                  text: "Backup"
                  text_font: roboto_16
                  text_color: 0x888888
        
        # System Info
        - label:
            id: system_info
            align: BOTTOM_LEFT
            x: 5
            y: -5
            text: "System OK"
            text_font: roboto_16
            text_color: 0x666666

# Fonts
font:
  - file: "gfonts://Roboto"
    id: roboto_24
    size: 24
  
  - file: "gfonts://Roboto"
    id: roboto_16
    size: 16
  
  - file: "gfonts://Roboto"
    id: roboto_32
    size: 32
  
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_32
    size: 32
    glyphs: [
      "\U000F0A72",  # solar-power
      "\U000F0239",  # transmission-tower
      "\U000F02DC",  # home
      "\U000F0079",  # battery
      "\U000F0DEE",  # leaf
      "\U000F0ADB",  # home-lightning-bolt
    ]
  
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_48
    size: 48
    glyphs: ["\U000F0DEE"]

# Updates
interval:
  - interval: 1s
    then:
      - lvgl.label.update:
          id: time_label
          text: !lambda |-
            auto time = id(ha_time).now();
            if (time.is_valid()) {
              static char buf[6];
              snprintf(buf, sizeof(buf), "%02d:%02d", time.hour, time.minute);
              return buf;
            }
            return "00:00";
      
      - lvgl.label.update:
          id: solar_value
          text: !lambda |-
            if (id(solar_power).has_state()) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.1f", id(solar_power).state);
              return buf;
            }
            return "0.0";
      
      - lvgl.arc.update:
          id: solar_arc
          value: !lambda |-
            if (id(solar_power).has_state()) {
              int arc_val = (int)(id(solar_power).state / 5.0 * 100);
              return arc_val > 100 ? 100 : arc_val;
            }
            return 0;
      
      - lvgl.label.update:
          id: grid_value
          text: !lambda |-
            if (id(grid_power).has_state()) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.1f", abs(id(grid_power).state));
              return buf;
            }
            return "0.0";
      
      - lvgl.arc.update:
          id: grid_arc
          value: !lambda |-
            if (id(grid_power).has_state()) {
              int arc_val = (int)(abs(id(grid_power).state) / 5.0 * 100);
              return arc_val > 100 ? 100 : arc_val;
            }
            return 0;
      
      - lvgl.label.update:
          id: home_value
          text: !lambda |-
            if (id(home_power).has_state()) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.1f", id(home_power).state);
              return buf;
            }
            return "0.0";
      
      - lvgl.arc.update:
          id: home_arc
          value: !lambda |-
            if (id(home_power).has_state()) {
              int arc_val = (int)(id(home_power).state / 5.0 * 100);
              return arc_val > 100 ? 100 : arc_val;
            }
            return 0;
      
      - lvgl.label.update:
          id: battery_value
          text: !lambda |-
            if (id(battery_power).has_state()) {
              static char buf[8];
              snprintf(buf, sizeof(buf), "%.1f", abs(id(battery_power).state));
              return buf;
            }
            return "0.0";
      
      - lvgl.arc.update:
          id: battery_arc
          value: !lambda |-
            if (id(battery_soc).has_state()) {
              return (int)id(battery_soc).state;
            }
            return 0;

  # Animation für Energiefluss-Segmente (transparente Linien mit leuchtendem Teil)
  - interval: 50ms
    then:
      - lambda: |-
          static int solar_pos = 0;
          static int grid_pos = 0;
          static int battery_pos = 0;
          static int home_pos = 0;
          static int backup_pos = 0;
          
          // Solar Segment Animation (vertical runter -> horizontal rechts)
          solar_pos = (solar_pos + 3) % 130;
          if (solar_pos < 40) {
            // Vertikal runter
            lv_obj_set_x(id(flow_segment_solar), 98);
            lv_obj_set_y(id(flow_segment_solar), 190 + solar_pos);
            lv_obj_set_width(id(flow_segment_solar), 4);
            lv_obj_set_height(id(flow_segment_solar), 20);
          } else if (solar_pos < 48) {
            // Kurve
            int curve = solar_pos - 40;
            lv_obj_set_x(id(flow_segment_solar), 98 + curve * 2);
            lv_obj_set_y(id(flow_segment_solar), 230 + curve);
            lv_obj_set_width(id(flow_segment_solar), 4);
            lv_obj_set_height(id(flow_segment_solar), 4);
          } else {
            // Horizontal rechts
            lv_obj_set_x(id(flow_segment_solar), 120 + (solar_pos - 48) * 1.1);
            lv_obj_set_y(id(flow_segment_solar), 236);
            lv_obj_set_width(id(flow_segment_solar), 20);
            lv_obj_set_height(id(flow_segment_solar), 4);
          }
          
          // Grid Segment Animation (horizontal rechts -> vertical hoch)
          grid_pos = (grid_pos + 3) % 120;
          if (grid_pos < 90) {
            // Horizontal rechts
            lv_obj_set_x(id(flow_segment_grid), 270 + grid_pos);
            lv_obj_set_y(id(flow_segment_grid), 218);
            lv_obj_set_width(id(flow_segment_grid), 20);
            lv_obj_set_height(id(flow_segment_grid), 4);
          } else if (grid_pos < 105) {
            // Kurve
            int curve = grid_pos - 90;
            lv_obj_set_x(id(flow_segment_grid), 360 + curve);
            lv_obj_set_y(id(flow_segment_grid), 218 - curve);
            lv_obj_set_width(id(flow_segment_grid), 4);
            lv_obj_set_height(id(flow_segment_grid), 4);
          } else {
            // Vertikal hoch
            lv_obj_set_x(id(flow_segment_grid), 376);
            lv_obj_set_y(id(flow_segment_grid), 195 - (grid_pos - 105) * 0.3);
            lv_obj_set_width(id(flow_segment_grid), 4);
            lv_obj_set_height(id(flow_segment_grid), 20);
          }
          
          // Battery Segment Animation (vertical hoch -> horizontal rechts)
          battery_pos = (battery_pos + 3) % 130;
          if (battery_pos < 45) {
            // Vertikal hoch
            lv_obj_set_x(id(flow_segment_battery), 98);
            lv_obj_set_y(id(flow_segment_battery), 330 - battery_pos);
            lv_obj_set_width(id(flow_segment_battery), 4);
            lv_obj_set_height(id(flow_segment_battery), 20);
          } else if (battery_pos < 53) {
            // Kurve
            int curve = battery_pos - 45;
            lv_obj_set_x(id(flow_segment_battery), 98 + curve * 2);
            lv_obj_set_y(id(flow_segment_battery), 285 - curve);
            lv_obj_set_width(id(flow_segment_battery), 4);
            lv_obj_set_height(id(flow_segment_battery), 4);
          } else {
            // Horizontal rechts
            lv_obj_set_x(id(flow_segment_battery), 120 + (battery_pos - 53) * 1.1);
            lv_obj_set_y(id(flow_segment_battery), 273);
            lv_obj_set_width(id(flow_segment_battery), 20);
            lv_obj_set_height(id(flow_segment_battery), 4);
          }
          
          // Home Segment Animation (direkt horizontal)
          home_pos = (home_pos + 3) % 60;
          lv_obj_set_x(id(flow_segment_home), 270 + home_pos);
          lv_obj_set_y(id(flow_segment_home), 258);
          lv_obj_set_width(id(flow_segment_home), 20);
          lv_obj_set_height(id(flow_segment_home), 4);
          
          // Backup Segment Animation (horizontal rechts -> vertical runter)
          backup_pos = (backup_pos + 3) % 120;
          if (backup_pos < 90) {
            // Horizontal rechts
            lv_obj_set_x(id(flow_segment_backup), 270 + backup_pos);
            lv_obj_set_y(id(flow_segment_backup), 293);
            lv_obj_set_width(id(flow_segment_backup), 20);
            lv_obj_set_height(id(flow_segment_backup), 4);
          } else if (backup_pos < 105) {
            // Kurve
            int curve = backup_pos - 90;
            lv_obj_set_x(id(flow_segment_backup), 360 + curve);
            lv_obj_set_y(id(flow_segment_backup), 293 + curve);
            lv_obj_set_width(id(flow_segment_backup), 4);
            lv_obj_set_height(id(flow_segment_backup), 4);
          } else {
            // Vertikal runter
            lv_obj_set_x(id(flow_segment_backup), 376);
            lv_obj_set_y(id(flow_segment_backup), 320 + (backup_pos - 105) * 0.7);
            lv_obj_set_width(id(flow_segment_backup), 4);
            lv_obj_set_height(id(flow_segment_backup), 20);
          }